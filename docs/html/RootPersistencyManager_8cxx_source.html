<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LDMX Software: SimApplication/src/RootPersistencyManager.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>SimApplication/src/RootPersistencyManager.cxx</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="RootPersistencyManager_8h.html" title="Class providing persistency manager implementation with SimEvent output.">SimApplication/RootPersistencyManager.h</a>&quot;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">// LDMX</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="EventHeader_8h.html" title="Class that provides header information about an event such as event number and timestamp...">Event/EventHeader.h</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="EventImpl_8h.html" title="Class implementing an event buffer system for storing event data.">Framework/EventImpl.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="EventConstants_8h.html" title="Class providing string constants for the event model.">Event/EventConstants.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="CalorimeterSD_8h.html" title="Class providing a basic calorimeter sensitive detector.">SimApplication/CalorimeterSD.h</a>&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="DetectorConstruction_8h.html" title="Class implementing the Geant4 detector construction.">SimApplication/DetectorConstruction.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="EcalHitIO_8h.html" title="Class providing hit readout for simulated LDMX ECal detector.">SimApplication/EcalHitIO.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="G4TrackerHit_8h.html" title="Class defining a tracker hit which is used to create output SimTrackerHit collection...">SimApplication/G4TrackerHit.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="RunManager_8h.html" title="Class providing a Geant4 run manager implementation.">SimApplication/RunManager.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="TrackerSD_8h.html" title="Class defining a basic sensitive detector for trackers.">SimApplication/TrackerSD.h</a>&quot;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">// Geant4</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;G4SDManager.hh&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;G4RunManager.hh&quot;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">namespace </span>ldmx {
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a58672f220ba86e1335cb5989504aa45e">00020</a>     <a class="code" href="classldmx_1_1RootPersistencyManager.html#a58672f220ba86e1335cb5989504aa45e">RootPersistencyManager::RootPersistencyManager</a>() :
<a name="l00021"></a>00021             G4PersistencyManager(G4PersistencyCenter::GetPersistencyCenter(), <span class="stringliteral">&quot;RootPersistencyManager&quot;</span>), ecalHitIO_(new <a class="code" href="classldmx_1_1EcalHitIO.html" title="Provides hit readout for simulated ECal detector.">EcalHitIO</a>(&amp;simParticleBuilder_)) {
<a name="l00022"></a>00022         G4PersistencyCenter::GetPersistencyCenter()-&gt;RegisterPersistencyManager(<span class="keyword">this</span>);
<a name="l00023"></a>00023         G4PersistencyCenter::GetPersistencyCenter()-&gt;SetPersistencyManager(<span class="keyword">this</span>, <span class="stringliteral">&quot;RootPersistencyManager&quot;</span>);
<a name="l00024"></a>00024 
<a name="l00025"></a>00025         event_ = <span class="keyword">new</span> <a class="code" href="classldmx_1_1EventImpl.html" title="Implements an event buffer system for storing event data.">EventImpl</a>(<span class="stringliteral">&quot;sim&quot;</span>);
<a name="l00026"></a>00026     }
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a069197da4dc51557b506bb9792b71447">00028</a>     G4bool <a class="code" href="classldmx_1_1RootPersistencyManager.html#a069197da4dc51557b506bb9792b71447">RootPersistencyManager::Store</a>(<span class="keyword">const</span> G4Event* anEvent) {
<a name="l00029"></a>00029 
<a name="l00030"></a>00030         <span class="comment">// verbose level 2</span>
<a name="l00031"></a>00031         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00032"></a>00032             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Storing event &quot;</span> &lt;&lt; anEvent-&gt;GetEventID() &lt;&lt; std::endl;
<a name="l00033"></a>00033         }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035         <span class="keywordflow">if</span> (G4RunManager::GetRunManager()-&gt;GetCurrentEvent()-&gt;IsAborted()) {
<a name="l00036"></a>00036             <span class="comment">// TODO: Need event cleanup here?</span>
<a name="l00037"></a>00037             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00038"></a>00038         }
<a name="l00039"></a>00039 
<a name="l00040"></a>00040         <span class="comment">// Build the output collections.</span>
<a name="l00041"></a>00041         <a class="code" href="classldmx_1_1RootPersistencyManager.html#adff5e5c920d492a7d8280d632f39a3fb">buildEvent</a>(anEvent, event_);
<a name="l00042"></a>00042 
<a name="l00043"></a>00043         <span class="comment">// Print out event info and data depending on verbose level.</span>
<a name="l00044"></a>00044         <a class="code" href="classldmx_1_1RootPersistencyManager.html#a0062be98365087e7635c1f889c31dd3c">printEvent</a>(event_);
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         outputFile_-&gt;nextEvent();
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00049"></a>00049     }
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#aa7ec73b20abe38c6a28b190703d61b01">00051</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa7ec73b20abe38c6a28b190703d61b01">RootPersistencyManager::writeRunHeader</a>(<span class="keyword">const</span> G4Run* aRun) {
<a name="l00052"></a>00052         <a class="code" href="classldmx_1_1RunHeader.html" title="Run header providing information about a set of events.">RunHeader</a>* runHeader = <a class="code" href="classldmx_1_1RootPersistencyManager.html#a16e715d52e6b843c325ec778adf35e97">createRunHeader</a>(aRun);
<a name="l00053"></a>00053         outputFile_-&gt;writeRunHeader(runHeader);
<a name="l00054"></a>00054         <span class="keyword">delete</span> runHeader;
<a name="l00055"></a>00055     }
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a12b731ddcd32f4dc0106a3f5d37c3344">00057</a>     G4bool <a class="code" href="classldmx_1_1RootPersistencyManager.html#a069197da4dc51557b506bb9792b71447">RootPersistencyManager::Store</a>(<span class="keyword">const</span> G4Run* aRun) {
<a name="l00058"></a>00058         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00059"></a>00059             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Storing run &quot;</span> &lt;&lt; aRun-&gt;GetRunID() &lt;&lt; std::endl;
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062         <span class="comment">// Write out the run header.</span>
<a name="l00063"></a>00063         <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa7ec73b20abe38c6a28b190703d61b01">writeRunHeader</a>(aRun);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="comment">// Close the file and delete the output file object.</span>
<a name="l00066"></a>00066         outputFile_-&gt;close();
<a name="l00067"></a>00067         <span class="keyword">delete</span> outputFile_;
<a name="l00068"></a>00068         outputFile_ = <span class="keyword">nullptr</span>;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00071"></a>00071     }
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#afd5c86b3280362e8b2fc09cd99d489e3">00073</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#afd5c86b3280362e8b2fc09cd99d489e3">RootPersistencyManager::Initialize</a>() {
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00076"></a>00076             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Opening output file &quot;</span> &lt;&lt; fileName_ &lt;&lt; std::endl;
<a name="l00077"></a>00077         }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="comment">// Create and setup the output file for writing the events.</span>
<a name="l00080"></a>00080         outputFile_ = <span class="keyword">new</span> <a class="code" href="classldmx_1_1EventFile.html" title="Manages a file of events.">EventFile</a>(fileName_.c_str(), <span class="keyword">true</span>, compressionLevel_);
<a name="l00081"></a>00081         outputFile_-&gt;setupEvent((<a class="code" href="classldmx_1_1EventImpl.html" title="Implements an event buffer system for storing event data.">EventImpl</a>*) event_);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         <span class="comment">// Create map with output hits collections.</span>
<a name="l00084"></a>00084         <a class="code" href="classldmx_1_1RootPersistencyManager.html#a77364c333447141311c9a2c300d1f554">setupHitsCollectionMap</a>();
<a name="l00085"></a>00085     }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#adff5e5c920d492a7d8280d632f39a3fb">00087</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#adff5e5c920d492a7d8280d632f39a3fb">RootPersistencyManager::buildEvent</a>(<span class="keyword">const</span> G4Event* anEvent, <a class="code" href="classldmx_1_1Event.html" title="Defines an interface for accessing event data.">Event</a>* outputEvent) {
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         <span class="comment">// Set basic event information.</span>
<a name="l00090"></a>00090         <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa9454abaf8230b229c1bed2f308fac5c">writeHeader</a>(anEvent, outputEvent);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">// Set pointer to current G4Event.</span>
<a name="l00093"></a>00093         <a class="code" href="classldmx_1_1RootPersistencyManager.html#a9146f9019f515fb1bae5a0456c114dfb">simParticleBuilder_</a>.<a class="code" href="classldmx_1_1SimParticleBuilder.html#a7e927d8bd9d73d4807581e343ffea7c4">setCurrentEvent</a>(anEvent);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095         <span class="comment">// Build the SimParticle list for the output ROOT event.</span>
<a name="l00096"></a>00096         <a class="code" href="classldmx_1_1RootPersistencyManager.html#a9146f9019f515fb1bae5a0456c114dfb">simParticleBuilder_</a>.<a class="code" href="classldmx_1_1SimParticleBuilder.html#a0066003cb33065699e1ef5cd212c86ba">buildSimParticles</a>(outputEvent);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <span class="comment">// Copy hit objects from SD hit collections into the output event.</span>
<a name="l00099"></a>00099         <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa4adc52feb9aa37a1d928055a0362e3d">writeHitsCollections</a>(anEvent, outputEvent);
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a0062be98365087e7635c1f889c31dd3c">00102</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#a0062be98365087e7635c1f889c31dd3c">RootPersistencyManager::printEvent</a>(<a class="code" href="classldmx_1_1Event.html" title="Defines an interface for accessing event data.">Event</a>* outputEvent) {
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="keyword">auto</span> particleColl = outputEvent-&gt;<a class="code" href="classldmx_1_1Event.html#a03be267c65510da262de65fd51c32c51">get</a>&lt;TClonesArray*&gt;(<span class="stringliteral">&quot;SimParticles&quot;</span>, <span class="stringliteral">&quot;sim&quot;</span>);
<a name="l00105"></a>00105         <span class="keywordflow">if</span> (!particleColl) {
<a name="l00106"></a>00106             <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;SimParticle output collection is null!&quot;</span>);
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00110"></a>00110             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Wrote &quot;</span> &lt;&lt; particleColl-&gt;GetEntriesFast() &lt;&lt; <span class="stringliteral">&quot; SimParticle objects&quot;</span> &lt;&lt; std::endl;
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keywordflow">if</span> (m_verbose &gt; 2) {
<a name="l00114"></a>00114             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iColl = 0; iColl &lt; particleColl-&gt;GetEntriesFast(); iColl++) {
<a name="l00115"></a>00115                 particleColl-&gt;At(iColl)-&gt;Print();
<a name="l00116"></a>00116             }
<a name="l00117"></a>00117             std::cout &lt;&lt; std::endl;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         <span class="keywordflow">for</span> (<span class="keyword">auto</span> entry : <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>) {
<a name="l00121"></a>00121             TClonesArray* hitsColl = entry.second;
<a name="l00122"></a>00122             <span class="keywordtype">int</span> entries = hitsColl-&gt;GetEntriesFast();
<a name="l00123"></a>00123             <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00124"></a>00124                 std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Wrote &quot;</span> &lt;&lt; hitsColl-&gt;GetEntriesFast() &lt;&lt; <span class="stringliteral">&quot; hits into &quot;</span> &lt;&lt; entry.first &lt;&lt; std::endl;
<a name="l00125"></a>00125             }
<a name="l00126"></a>00126             <span class="keywordflow">if</span> (m_verbose &gt; 2) {
<a name="l00127"></a>00127                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iColl = 0; iColl &lt; entries; iColl++) {
<a name="l00128"></a>00128                     TObject* obj = (*hitsColl)[iColl];
<a name="l00129"></a>00129                     obj-&gt;Print(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00130"></a>00130                 }
<a name="l00131"></a>00131                 std::cout &lt;&lt; std::endl;
<a name="l00132"></a>00132             }
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 
<a name="l00136"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#aa9454abaf8230b229c1bed2f308fac5c">00136</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa9454abaf8230b229c1bed2f308fac5c">RootPersistencyManager::writeHeader</a>(<span class="keyword">const</span> G4Event* anEvent, <a class="code" href="classldmx_1_1Event.html" title="Defines an interface for accessing event data.">Event</a>* outputEvent) {
<a name="l00137"></a>00137         <a class="code" href="classldmx_1_1EventHeader.html" title="Provides header information an event such as event number and timestamp.">EventHeader</a>&amp; eventHeader = ((<a class="code" href="classldmx_1_1EventImpl.html" title="Implements an event buffer system for storing event data.">EventImpl</a>*) outputEvent)-&gt;getEventHeaderMutable();
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#a543282b0c2d592d06d08db72ad4cc6f0">setEventNumber</a>(anEvent-&gt;GetEventID());
<a name="l00140"></a>00140         TTimeStamp ts;
<a name="l00141"></a>00141         ts.SetSec((<span class="keywordtype">int</span>) time(NULL));
<a name="l00142"></a>00142         eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#a9ca1cf604267d7c5d3fd74d59d252f4c">setTimestamp</a>(ts);
<a name="l00143"></a>00143         eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#a71465aa9df92ce5322c6c1f41c321b0c">setRun</a>(G4RunManager::GetRunManager()-&gt;GetCurrentRun()-&gt;GetRunID());
<a name="l00144"></a>00144         <span class="keywordflow">if</span> (<a class="code" href="classldmx_1_1BiasingMessenger.html#a0668146bf1b85aec05561c65acd417e1">BiasingMessenger::isBiasingEnabled</a>()) {
<a name="l00145"></a>00145             eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#aa8f6573736b28832a40832ab096d2b04">setWeight</a>(<a class="code" href="classldmx_1_1BiasingMessenger.html#ad0e4aad135b97385f04105fd76a59be9">BiasingMessenger::getEventWeight</a>());
<a name="l00146"></a>00146         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (anEvent-&gt;GetPrimaryVertex(0)) {
<a name="l00147"></a>00147             eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#aa8f6573736b28832a40832ab096d2b04">setWeight</a>(anEvent-&gt;GetPrimaryVertex(0)-&gt;GetWeight());
<a name="l00148"></a>00148         }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         std::string seedString = <a class="code" href="classldmx_1_1RootPersistencyManager.html#a592eba23c679e888682c68939fe81881">getEventSeeds</a>();
<a name="l00151"></a>00151         eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#a76278afb56af7f15326824dc9ecacbf8">setStringParameter</a>(<span class="stringliteral">&quot;eventSeed&quot;</span>, seedString);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00154"></a>00154             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] : Wrote event header for event ID &quot;</span> &lt;&lt; anEvent-&gt;GetEventID() &lt;&lt; std::endl;
<a name="l00155"></a>00155             std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span>;
<a name="l00156"></a>00156             eventHeader.<a class="code" href="classldmx_1_1EventHeader.html#a74fcbd2952a576296fa5773a2a52b5bc">Print</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a592eba23c679e888682c68939fe81881">00160</a>     std::string <a class="code" href="classldmx_1_1RootPersistencyManager.html#a592eba23c679e888682c68939fe81881">RootPersistencyManager::getEventSeeds</a>(std::string fileName) {
<a name="l00161"></a>00161         std::ifstream t(fileName);
<a name="l00162"></a>00162         std::stringstream buffer;
<a name="l00163"></a>00163         buffer &lt;&lt; t.rdbuf();
<a name="l00164"></a>00164         t.close();
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <span class="keywordflow">return</span> buffer.str();
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#aa4adc52feb9aa37a1d928055a0362e3d">00169</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#aa4adc52feb9aa37a1d928055a0362e3d">RootPersistencyManager::writeHitsCollections</a>(<span class="keyword">const</span> G4Event* anEvent, <a class="code" href="classldmx_1_1Event.html" title="Defines an interface for accessing event data.">Event</a>* outputEvent) {
<a name="l00170"></a>00170 
<a name="l00171"></a>00171         <span class="comment">// Clear the hits from last event.</span>
<a name="l00172"></a>00172         <span class="keywordflow">for</span> (<span class="keyword">auto</span> entry : <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>) {
<a name="l00173"></a>00173             entry.second-&gt;Clear(<span class="stringliteral">&quot;C&quot;</span>);
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="comment">// Get the HC of this event.</span>
<a name="l00177"></a>00177         G4HCofThisEvent* hce = anEvent-&gt;GetHCofThisEvent();
<a name="l00178"></a>00178         <span class="keywordtype">int</span> nColl = hce-&gt;GetNumberOfCollections();
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="comment">// Loop over all hits collections.</span>
<a name="l00181"></a>00181         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iColl = 0; iColl &lt; nColl; iColl++) {
<a name="l00182"></a>00182 
<a name="l00183"></a>00183             <span class="comment">// Get a hits collection and its name.</span>
<a name="l00184"></a>00184             G4VHitsCollection* hc = hce-&gt;GetHC(iColl);
<a name="l00185"></a>00185             std::string collName = hc-&gt;GetName();
<a name="l00186"></a>00186 
<a name="l00187"></a>00187             <span class="comment">// Get the target output collection.</span>
<a name="l00188"></a>00188             TClonesArray* outputHitsColl = outputHitsCollections_[collName];
<a name="l00189"></a>00189 
<a name="l00190"></a>00190             <span class="comment">// If the collection is not found in the output ROOT event, then a fatal error occurs!</span>
<a name="l00191"></a>00191             <span class="keywordflow">if</span> (!outputHitsColl) {
<a name="l00192"></a>00192                 std::cerr &lt;&lt; <span class="stringliteral">&quot;ERROR: The output collection &quot;</span> &lt;&lt; collName &lt;&lt; <span class="stringliteral">&quot; was not found!&quot;</span> &lt;&lt; std::endl;
<a name="l00193"></a>00193                 G4Exception(<span class="stringliteral">&quot;RootPersistencyManager::writeHitsCollections&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, FatalException, <span class="stringliteral">&quot;The output collection was not found.&quot;</span>);
<a name="l00194"></a>00194             }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196             <span class="keywordflow">if</span> (dynamic_cast&lt;G4TrackerHitsCollection*&gt;(hc) != <span class="keyword">nullptr</span>) {
<a name="l00197"></a>00197 
<a name="l00198"></a>00198                 <span class="comment">// Write G4TrackerHit collection to output SimTrackerHit collection.</span>
<a name="l00199"></a>00199                 G4TrackerHitsCollection* trackerHitsColl = <span class="keyword">dynamic_cast&lt;</span>G4TrackerHitsCollection*<span class="keyword">&gt;</span>(hc);
<a name="l00200"></a>00200                 <a class="code" href="classldmx_1_1RootPersistencyManager.html#a081c4bf1358bdeb8b943f8f4032349f8">writeTrackerHitsCollection</a>(trackerHitsColl, outputHitsColl);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dynamic_cast&lt;G4CalorimeterHitsCollection*&gt;(hc) != <span class="keyword">nullptr</span>) {
<a name="l00203"></a>00203 
<a name="l00204"></a>00204                 G4CalorimeterHitsCollection* calHitsColl = <span class="keyword">dynamic_cast&lt;</span>G4CalorimeterHitsCollection*<span class="keyword">&gt;</span>(hc);
<a name="l00205"></a>00205                 <span class="keywordflow">if</span> (collName == EventConstants::ECAL_SIM_HITS) {
<a name="l00206"></a>00206                     <span class="comment">// Write ECal G4CalorimeterHit collection to output SimCalorimeterHit collection using helper class.</span>
<a name="l00207"></a>00207                     <a class="code" href="classldmx_1_1RootPersistencyManager.html#a1d07ec856dd975b5564ebacf40d29995">ecalHitIO_</a>-&gt;<a class="code" href="classldmx_1_1EcalHitIO.html#aa21c0068c29e699bc4aa31511667383e">writeHitsCollection</a>(calHitsColl, outputHitsColl);
<a name="l00208"></a>00208                 } <span class="keywordflow">else</span> {
<a name="l00209"></a>00209                     <span class="comment">// Write generic G4CalorimeterHit collection to output SimCalorimeterHit collection.</span>
<a name="l00210"></a>00210                     <a class="code" href="classldmx_1_1RootPersistencyManager.html#a8198a661380f13f11ebdb89a2fdffda7">writeCalorimeterHitsCollection</a>(calHitsColl, outputHitsColl);
<a name="l00211"></a>00211                 }
<a name="l00212"></a>00212             }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214             <span class="comment">// Add hits collection to output event.</span>
<a name="l00215"></a>00215             outputEvent-&gt;<a class="code" href="classldmx_1_1Event.html#ab5ea7b34778f5cf8d40504cdf9e69113">add</a>(collName, outputHitsColl);
<a name="l00216"></a>00216         }
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a081c4bf1358bdeb8b943f8f4032349f8">00219</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#a081c4bf1358bdeb8b943f8f4032349f8">RootPersistencyManager::writeTrackerHitsCollection</a>(G4TrackerHitsCollection* hc, TClonesArray* outputColl) {
<a name="l00220"></a>00220         <span class="keywordtype">int</span> nHits = hc-&gt;GetSize();
<a name="l00221"></a>00221         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iHit = 0; iHit &lt; nHits; iHit++) {
<a name="l00222"></a>00222             <a class="code" href="classldmx_1_1G4TrackerHit.html" title="Track hit which is used to create output SimTrackerHit collection.">G4TrackerHit</a>* g4hit = (<a class="code" href="classldmx_1_1G4TrackerHit.html" title="Track hit which is used to create output SimTrackerHit collection.">G4TrackerHit</a>*) hc-&gt;GetHit(iHit);
<a name="l00223"></a>00223             <a class="code" href="classldmx_1_1SimTrackerHit.html" title="Represents a simulated tracker hit in the simulation.">SimTrackerHit</a>* simTrackerHit = (<a class="code" href="classldmx_1_1SimTrackerHit.html" title="Represents a simulated tracker hit in the simulation.">SimTrackerHit</a>*) outputColl-&gt;ConstructedAt(outputColl-&gt;GetEntries());
<a name="l00224"></a>00224             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a639044b03ced00dbec1e08d4ea158e1b">setID</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#a53860f24ea78e9a2bf73d834e5cd68b6">getID</a>());
<a name="l00225"></a>00225             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a766dff1ca723236e48f8ef6d88f6d0c9">setLayerID</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#a51f5705abc8654664ab93d982223fa5d">getLayerID</a>());
<a name="l00226"></a>00226             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a007a15befbe02ec190b4e6ef2cebe25d">setEdep</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#a03121c11c30db3fd2bdb189908e3c25b">getEdep</a>());
<a name="l00227"></a>00227             <span class="keyword">const</span> G4ThreeVector&amp; momentum = g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#ac1d35d1f45c836828dbd7a76f2fea452">getMomentum</a>();
<a name="l00228"></a>00228             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#ae5ffa11967342e6bc8f8bcb03fc7fcea">setMomentum</a>(momentum.x(), momentum.y(), momentum.z());
<a name="l00229"></a>00229             <span class="keyword">const</span> G4ThreeVector&amp; position = g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#a86d6db2b45885b53a68ec5223f9940f1">getPosition</a>();
<a name="l00230"></a>00230             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a662fc20bd8c86ae209c0b1efdf76a889">setPosition</a>(position.x(), position.y(), position.z());
<a name="l00231"></a>00231             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a8b8f72e6d6094e56ddabc1548a071503">setPathLength</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#ae6c3189d5fe54c88c550a5058daae21d">getPathLength</a>());
<a name="l00232"></a>00232             <a class="code" href="classldmx_1_1SimParticle.html" title="Represents MC particle information from a track in the simulation.">SimParticle</a>* simParticle = <a class="code" href="classldmx_1_1RootPersistencyManager.html#a9146f9019f515fb1bae5a0456c114dfb">simParticleBuilder_</a>.<a class="code" href="classldmx_1_1SimParticleBuilder.html#a186857e6055f574b6aa266daa51f308b">findSimParticle</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4TrackerHit.html#a1470169e90d4f0f575e9130e38aafb43">getTrackID</a>());
<a name="l00233"></a>00233             simTrackerHit-&gt;<a class="code" href="classldmx_1_1SimTrackerHit.html#a9fc99eab42276e9492e2e6e113fcc87f">setSimParticle</a>(simParticle);
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a8198a661380f13f11ebdb89a2fdffda7">00237</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#a8198a661380f13f11ebdb89a2fdffda7">RootPersistencyManager::writeCalorimeterHitsCollection</a>(G4CalorimeterHitsCollection* hc, TClonesArray* outputColl) {
<a name="l00238"></a>00238         <span class="keywordtype">int</span> nHits = hc-&gt;GetSize();
<a name="l00239"></a>00239         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iHit = 0; iHit &lt; nHits; iHit++) {
<a name="l00240"></a>00240             <a class="code" href="classldmx_1_1G4CalorimeterHit.html" title="Calorimeter hit which is used to create output SimCalorimeterHit objects.">G4CalorimeterHit</a>* g4hit = (<a class="code" href="classldmx_1_1G4CalorimeterHit.html" title="Calorimeter hit which is used to create output SimCalorimeterHit objects.">G4CalorimeterHit</a>*) hc-&gt;GetHit(iHit);
<a name="l00241"></a>00241             <a class="code" href="classldmx_1_1SimCalorimeterHit.html" title="Stores simulated calorimeter hit information.">SimCalorimeterHit</a>* simHit = (<a class="code" href="classldmx_1_1SimCalorimeterHit.html" title="Stores simulated calorimeter hit information.">SimCalorimeterHit</a>*) outputColl-&gt;ConstructedAt(outputColl-&gt;GetEntries());
<a name="l00242"></a>00242             simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a8748f89687f78fc1a329bf59bf5541dd">setID</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a669474e22b47d59d658c277953356c6e">getID</a>());
<a name="l00243"></a>00243             <span class="keyword">const</span> G4ThreeVector&amp; pos = g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a8f57ae1472ef5317ce1cb250bc84a031">getPosition</a>();
<a name="l00244"></a>00244             simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a59e6d97f1f20152bd0d80420d63c1003">setPosition</a>(pos.x(), pos.y(), pos.z());
<a name="l00245"></a>00245             <a class="code" href="classldmx_1_1SimParticle.html" title="Represents MC particle information from a track in the simulation.">SimParticle</a>* particle = <a class="code" href="classldmx_1_1RootPersistencyManager.html#a9146f9019f515fb1bae5a0456c114dfb">simParticleBuilder_</a>.<a class="code" href="classldmx_1_1SimParticleBuilder.html#a186857e6055f574b6aa266daa51f308b">findSimParticle</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#acbc7cc180e084bc61aaa320cbce551c9">getTrackID</a>());
<a name="l00246"></a>00246             simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a1a20449da8799af727d4f1b4c7fe59e9">addContrib</a>(particle, g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#aab36fe634a082f1fa4c7cd32d3df4673">getPdgCode</a>(), g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#ae9dc23f470d9f543d4acabaabc791491">getEdep</a>(), g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a52ceaf729ae50da534fb7fad3840a7f4">getTime</a>());
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a16e715d52e6b843c325ec778adf35e97">00250</a>     <a class="code" href="classldmx_1_1RunHeader.html" title="Run header providing information about a set of events.">RunHeader</a>* <a class="code" href="classldmx_1_1RootPersistencyManager.html#a16e715d52e6b843c325ec778adf35e97">RootPersistencyManager::createRunHeader</a>(<span class="keyword">const</span> G4Run* aRun) {
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">// Get detector header from the user detector construction.</span>
<a name="l00253"></a>00253         <a class="code" href="classldmx_1_1DetectorConstruction.html" title="Implements the Geant4 detector construction.">DetectorConstruction</a>* detector = ((<a class="code" href="classldmx_1_1RunManager.html" title="Extension of Geant4 run manager.">RunManager</a>*) RunManager::GetRunManager())-&gt;getDetectorConstruction();
<a name="l00254"></a>00254         <a class="code" href="classldmx_1_1DetectorHeader.html" title="Defines detector header information.">DetectorHeader</a>* detectorHeader = detector-&gt;<a class="code" href="classldmx_1_1DetectorConstruction.html#ad0809a1a4002fd4e6806691021485dee">getDetectorHeader</a>();
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">// Create the run header.</span>
<a name="l00257"></a>00257         <a class="code" href="classldmx_1_1RunHeader.html" title="Run header providing information about a set of events.">RunHeader</a>* runHeader = <span class="keyword">new</span> <a class="code" href="classldmx_1_1RunHeader.html" title="Run header providing information about a set of events.">RunHeader</a>(aRun-&gt;GetRunID(), detectorHeader-&gt;<a class="code" href="classldmx_1_1DetectorHeader.html#a04f3dd3a9a7238e1c0ee95b9c7ba2698">getName</a>(), detectorHeader-&gt;<a class="code" href="classldmx_1_1DetectorHeader.html#aacc920a53f8384f076ab65fa0232e62d">getVersion</a>(), <span class="stringliteral">&quot;LDMX sim events&quot;</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="comment">// Set parameter value with number of events processed.</span>
<a name="l00260"></a>00260         runHeader-&gt;<a class="code" href="classldmx_1_1RunHeader.html#af018cc3e5c3bf3645dbeb22796d355df">setIntParameter</a>(<span class="stringliteral">&quot;EVENT_COUNT&quot;</span>, aRun-&gt;GetNumberOfEvent());
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         <span class="comment">// Print information about run header.</span>
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00264"></a>00264             std::cout &lt;&lt; std::endl;
<a name="l00265"></a>00265             std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] - Created run header for run ID &quot;</span> &lt;&lt; aRun-&gt;GetRunID() &lt;&lt; std::endl;
<a name="l00266"></a>00266             std::cout &lt;&lt; <span class="stringliteral">&quot;  run number: &quot;</span> &lt;&lt; runHeader-&gt;<a class="code" href="classldmx_1_1RunHeader.html#a0d5d1d1937d042892dbe821d0257e4ef">getRunNumber</a>() &lt;&lt; std::endl;
<a name="l00267"></a>00267             std::cout &lt;&lt; <span class="stringliteral">&quot;  detector name: &quot;</span> &lt;&lt; runHeader-&gt;<a class="code" href="classldmx_1_1RunHeader.html#acc95cf00bfc5c05562e17673e9ed10d9">getDetectorName</a>() &lt;&lt; std::endl;
<a name="l00268"></a>00268             std::cout &lt;&lt; <span class="stringliteral">&quot;  detector version: &quot;</span> &lt;&lt; runHeader-&gt;<a class="code" href="classldmx_1_1RunHeader.html#acf57c030863a962f21f775e9a192080c">getDetectorVersion</a>() &lt;&lt; std::endl;
<a name="l00269"></a>00269             std::cout &lt;&lt; <span class="stringliteral">&quot;  description: &quot;</span> &lt;&lt; runHeader-&gt;<a class="code" href="classldmx_1_1RunHeader.html#a3c3c5aa973cc8341d330c42bec1100f1">getDescription</a>() &lt;&lt; std::endl;
<a name="l00270"></a>00270             std::cout &lt;&lt; std::endl;
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="keywordflow">return</span> runHeader;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="classldmx_1_1RootPersistencyManager.html#a77364c333447141311c9a2c300d1f554">00276</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1RootPersistencyManager.html#a77364c333447141311c9a2c300d1f554">RootPersistencyManager::setupHitsCollectionMap</a>() {
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">// Clear any state from the last run.</span>
<a name="l00279"></a>00279         <span class="keywordflow">if</span> (<a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>.size()) {
<a name="l00280"></a>00280             <span class="keywordflow">for</span> (<span class="keyword">auto</span> entry : <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>) {
<a name="l00281"></a>00281                 <span class="keyword">delete</span> entry.second;
<a name="l00282"></a>00282             }
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284         <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>.clear();
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         <span class="comment">// Create an output TClonesArray in the map for each registered HC.</span>
<a name="l00287"></a>00287         G4SDManager* sdMgr = G4SDManager::GetSDMpointer();
<a name="l00288"></a>00288         G4HCtable* hcTable = sdMgr-&gt;GetHCtable();
<a name="l00289"></a>00289         <span class="keywordtype">int</span> entries = hcTable-&gt;entries();
<a name="l00290"></a>00290         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; entries; i++) {
<a name="l00291"></a>00291             std::string sdName = hcTable-&gt;GetSDname(i);
<a name="l00292"></a>00292             std::string hcName = hcTable-&gt;GetHCname(i);
<a name="l00293"></a>00293             G4VSensitiveDetector* sd = sdMgr-&gt;FindSensitiveDetector(sdName);
<a name="l00294"></a>00294             <span class="keywordflow">if</span> (dynamic_cast&lt;CalorimeterSD*&gt;(sd)) {
<a name="l00295"></a>00295                 <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>[hcName] = <span class="keyword">new</span> TClonesArray(EventConstants::SIM_CALORIMETER_HIT.c_str(), 500);
<a name="l00296"></a>00296                 <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00297"></a>00297                     std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] - Created SimCalorimeterHit HC &quot;</span> &lt;&lt; hcName &lt;&lt; std::endl;
<a name="l00298"></a>00298                 }
<a name="l00299"></a>00299             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dynamic_cast&lt;TrackerSD*&gt;(sd)) {
<a name="l00300"></a>00300                 <a class="code" href="classldmx_1_1RootPersistencyManager.html#a18dd31bb0e4440d47b3db3441835f893">outputHitsCollections_</a>[hcName] = <span class="keyword">new</span> TClonesArray(EventConstants::SIM_TRACKER_HIT.c_str(), 50);
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> (m_verbose &gt; 1) {
<a name="l00302"></a>00302                     std::cout &lt;&lt; <span class="stringliteral">&quot;[ RootPersistencyManager ] - Created SimTrackerHit HC &quot;</span> &lt;&lt; hcName &lt;&lt; std::endl;
<a name="l00303"></a>00303                 }
<a name="l00304"></a>00304             }
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 } <span class="comment">// namespace sim</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 7 Jul 2017 for LDMX Software by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
