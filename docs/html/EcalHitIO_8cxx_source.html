<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LDMX Software: SimApplication/src/EcalHitIO.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LDMX Software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">SimApplication/src/EcalHitIO.cxx</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="EcalHitIO_8h.html" title="Class providing hit readout for simulated LDMX ECal detector.">SimApplication/EcalHitIO.h</a>&quot;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">// STL</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="comment">// LDMX</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="SimCalorimeterHit_8h.html" title="Class which stores simulated calorimeter hit information.">Event/SimCalorimeterHit.h</a>&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="SimParticle_8h.html" title="Class which implements an MC particle that stores information about tracks from the simulation...">Event/SimParticle.h</a>&quot;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="keyword">namespace </span>ldmx {
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="classldmx_1_1EcalHitIO.html#a0164ae914762d87b1efa39e7f8df5b8b">00012</a>     <a class="code" href="classldmx_1_1EcalHitIO.html#a0164ae914762d87b1efa39e7f8df5b8b">EcalHitIO::EcalHitIO</a>(<a class="code" href="classldmx_1_1SimParticleBuilder.html" title="Builds output SimParticle collection from Trajectory container.">SimParticleBuilder</a>* simParticleBuilder) :
<a name="l00013"></a>00013             simParticleBuilder_(simParticleBuilder) {
<a name="l00014"></a>00014     }
<a name="l00015"></a>00015 
<a name="l00016"></a><a class="code" href="classldmx_1_1EcalHitIO.html#aa21c0068c29e699bc4aa31511667383e">00016</a>     <span class="keywordtype">void</span> <a class="code" href="classldmx_1_1EcalHitIO.html#aa21c0068c29e699bc4aa31511667383e">EcalHitIO::writeHitsCollection</a>(G4CalorimeterHitsCollection* hc, TClonesArray* outputColl) {
<a name="l00017"></a>00017 
<a name="l00018"></a>00018         <span class="keywordtype">int</span> nHits = hc-&gt;GetSize();
<a name="l00019"></a>00019         std::map&lt;int, SimCalorimeterHit*&gt; hitMap;
<a name="l00020"></a>00020 
<a name="l00021"></a>00021         <span class="comment">// Loop over input hits from Geant4.</span>
<a name="l00022"></a>00022         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iHit = 0; iHit &lt; nHits; iHit++) {
<a name="l00023"></a>00023 
<a name="l00024"></a>00024             <span class="comment">// Get the hit and its ID.</span>
<a name="l00025"></a>00025             <a class="code" href="classldmx_1_1G4CalorimeterHit.html" title="Calorimeter hit which is used to create output SimCalorimeterHit objects.">G4CalorimeterHit</a>* g4hit = (<a class="code" href="classldmx_1_1G4CalorimeterHit.html" title="Calorimeter hit which is used to create output SimCalorimeterHit objects.">G4CalorimeterHit</a>*) hc-&gt;GetHit(iHit);
<a name="l00026"></a>00026             <span class="keywordtype">int</span> hitID = g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a669474e22b47d59d658c277953356c6e">getID</a>();
<a name="l00027"></a>00027 
<a name="l00028"></a>00028             <span class="comment">// See if hit exists in map already.</span>
<a name="l00029"></a>00029             std::map&lt;int, SimCalorimeterHit*&gt;::iterator it = hitMap.find(hitID);
<a name="l00030"></a>00030             <a class="code" href="classldmx_1_1SimCalorimeterHit.html" title="Stores simulated calorimeter hit information.">SimCalorimeterHit</a>* simHit;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032             <span class="comment">// Is it a new hit?</span>
<a name="l00033"></a>00033             <span class="keywordflow">if</span> (it == hitMap.end()) {
<a name="l00034"></a>00034 
<a name="l00035"></a>00035                 <span class="comment">// Create sim hit and assign the ID.</span>
<a name="l00036"></a>00036                 simHit = (<a class="code" href="classldmx_1_1SimCalorimeterHit.html" title="Stores simulated calorimeter hit information.">SimCalorimeterHit</a>*) outputColl-&gt;ConstructedAt(outputColl-&gt;GetEntries());
<a name="l00037"></a>00037                 simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a8748f89687f78fc1a329bf59bf5541dd">setID</a>(hitID);
<a name="l00038"></a>00038 
<a name="l00043"></a>00043                 <a class="code" href="classldmx_1_1EcalHitIO.html#a86496eb808fd28c195136a61f578ad0d">detID_</a>.<a class="code" href="classldmx_1_1DetectorID.html#a0ab7435051b257d4974ce87c0a1772cd">setRawValue</a>(hitID);
<a name="l00044"></a>00044                 <a class="code" href="classldmx_1_1EcalHitIO.html#a86496eb808fd28c195136a61f578ad0d">detID_</a>.<a class="code" href="classldmx_1_1DetectorID.html#aed9bd3abdb7038a7a43ca4d9eed91b85">unpack</a>();
<a name="l00045"></a>00045                 <span class="keywordtype">int</span> cellID = <a class="code" href="classldmx_1_1EcalHitIO.html#a86496eb808fd28c195136a61f578ad0d">detID_</a>.<a class="code" href="classldmx_1_1DetectorID.html#ae95e1cc6a9bbb0ba8e0961f3a4b02841">getFieldValue</a>(<span class="stringliteral">&quot;cell&quot;</span>);
<a name="l00046"></a>00046                 std::pair&lt;float, float&gt; XYPair = <a class="code" href="classldmx_1_1EcalHitIO.html#a2da88330887b700c31eddeba05a7046b">hexReadout_</a>.<a class="code" href="classldmx_1_1EcalHexReadout.html#a97a4fd396db26d47ea43f14d7c8d3bb0">getCellCentroidXYPair</a>(cellID);
<a name="l00047"></a>00047                 simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a59e6d97f1f20152bd0d80420d63c1003">setPosition</a>(XYPair.first, XYPair.second, g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a8f57ae1472ef5317ce1cb250bc84a031">getPosition</a>().z());
<a name="l00048"></a>00048 
<a name="l00049"></a>00049                 hitMap[hitID] = simHit;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051             } <span class="keywordflow">else</span> {
<a name="l00052"></a>00052                 <span class="comment">// Get existing hit from map.</span>
<a name="l00053"></a>00053                 simHit = hitMap[hitID];
<a name="l00054"></a>00054             }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056             <span class="comment">// Get info from the G4 hit.</span>
<a name="l00057"></a>00057             <span class="keywordtype">float</span> edep = g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#ae9dc23f470d9f543d4acabaabc791491">getEdep</a>();
<a name="l00058"></a>00058             <span class="keywordtype">float</span> time = g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#a52ceaf729ae50da534fb7fad3840a7f4">getTime</a>();
<a name="l00059"></a>00059             <span class="keywordtype">int</span> pdgCode = g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#aab36fe634a082f1fa4c7cd32d3df4673">getPdgCode</a>();
<a name="l00060"></a>00060 
<a name="l00061"></a>00061             <span class="comment">// Is hit contrib output enabled?</span>
<a name="l00062"></a>00062             <span class="keywordflow">if</span> (enableHitContribs_) {
<a name="l00063"></a>00063 
<a name="l00064"></a>00064                 <span class="comment">// Find the SimParticle associated with this hit.</span>
<a name="l00065"></a>00065                 <a class="code" href="classldmx_1_1SimParticle.html" title="Represents MC particle information from a track in the simulation.">SimParticle</a>* simParticle = <a class="code" href="classldmx_1_1EcalHitIO.html#aebb0a0e506932468021916d593b58b25">simParticleBuilder_</a>-&gt;<a class="code" href="classldmx_1_1SimParticleBuilder.html#a186857e6055f574b6aa266daa51f308b">findSimParticle</a>(g4hit-&gt;<a class="code" href="classldmx_1_1G4CalorimeterHit.html#acbc7cc180e084bc61aaa320cbce551c9">getTrackID</a>());
<a name="l00066"></a>00066 
<a name="l00067"></a>00067                 <span class="comment">// Find if there is an existing hit contrib.</span>
<a name="l00068"></a>00068                 <span class="keywordtype">int</span> contribIndex = simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#af77332d773f973599f34b70248a39c8b">findContribIndex</a>(simParticle, pdgCode);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070                 <span class="comment">// Is contrib output being compressed and a record exists for this SimParticle and PDG code?</span>
<a name="l00071"></a>00071                 <span class="keywordflow">if</span> (compressHitContribs_ &amp;&amp; contribIndex != -1) {
<a name="l00072"></a>00072 
<a name="l00073"></a>00073                     <span class="comment">// Update an existing hit contrib.</span>
<a name="l00074"></a>00074                     simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#ae34275895ddacf40c6bab12618eeaa06">updateContrib</a>(contribIndex, edep, time);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076                     <span class="comment">//std::cout &lt;&lt; &quot;updated contrib for hit with ID &quot; &lt;&lt; hitID &lt;&lt; &quot; with PDGID = &quot;</span>
<a name="l00077"></a>00077                     <span class="comment">//        &lt;&lt; pdgCode &lt;&lt; &quot;, edep = &quot; &lt;&lt; edep &lt;&lt; &quot;, time = &quot; &lt;&lt; time &lt;&lt; std::endl;;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079                 } <span class="keywordflow">else</span> {
<a name="l00080"></a>00080 
<a name="l00081"></a>00081                     <span class="comment">// Add a hit contrib because all steps are being saved or there is not an existing record.</span>
<a name="l00082"></a>00082                     simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a1a20449da8799af727d4f1b4c7fe59e9">addContrib</a>(simParticle, pdgCode, edep, time);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084                     <span class="comment">//std::cout &lt;&lt; &quot;added new contrib for hit with ID &quot; &lt;&lt; hitID &lt;&lt; &quot; with PDGID = &quot;</span>
<a name="l00085"></a>00085                     <span class="comment">//        &lt;&lt; pdgCode &lt;&lt; &quot;, edep = &quot; &lt;&lt; edep &lt;&lt; &quot;, time = &quot; &lt;&lt; time &lt;&lt; std::endl;</span>
<a name="l00086"></a>00086                 }
<a name="l00087"></a>00087             } <span class="keywordflow">else</span> {
<a name="l00088"></a>00088 
<a name="l00089"></a>00089                 <span class="comment">// Hit contributions are not being saved so manually increment the edep and set time.</span>
<a name="l00090"></a>00090                 simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a4ab851fd3f7b7664da01c845b1de78b3">setEdep</a>(simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a16c19eeaab38d7dfbd33e3def3d6a69e">getEdep</a>() + edep);
<a name="l00091"></a>00091                 <span class="keywordflow">if</span> (time &lt; simHit-&gt;getTime() || simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#a5aa10cbab3e58a989d3c01c2886c4f23">getTime</a>() == 0) {
<a name="l00092"></a>00092                     simHit-&gt;<a class="code" href="classldmx_1_1SimCalorimeterHit.html#abe88e7032f2dd55511b22eb45df83993">setTime</a>(time);
<a name="l00093"></a>00093                 }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                 <span class="comment">//std::cout &lt;&lt; &quot;updated hit with ID &quot; &lt;&lt; hitID &lt;&lt; &quot; with edep = &quot; &lt;&lt; edep &lt;&lt; &quot;, time = &quot; &lt;&lt; time &lt;&lt; std::endl;</span>
<a name="l00096"></a>00096             }
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 } <span class="comment">// namespace sim</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
